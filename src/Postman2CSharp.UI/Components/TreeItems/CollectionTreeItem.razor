@inherits MainLayoutComponent

@if (ApiClientGroups != null)
{
    <MudBreakpointProvider>
        <MudHidden Breakpoint="Breakpoint.LgAndUp">
            @{
                GroupApiClients(2);
            }
        </MudHidden>
        <MudHidden Breakpoint="Breakpoint.MdAndDown">
            @{
                GroupApiClients(3);
            }
        </MudHidden>
    </MudBreakpointProvider>
    <MudTreeView T="string" Class="collection-tree-root" Hover ExpandOnClick>
     <CascadingValue Value="this">
         @foreach (var group in ApiClientGroups)
         {
             <div class="f-column">
                 @foreach (var apiClient in group)
                 {
                     <ApiClientTreeItem ApiClient="apiClient" ApiCollection="ApiCollection"/>
                 }
             </div>
         }
     </CascadingValue>
    </MudTreeView>
}

@code {

    [Parameter]
    public ApiCollection? ApiCollection { get; set; }

    private List<List<ApiClient>>? ApiClientGroups { get; set; }

    private ApiCollection? _cachedApiCollection;
    protected override void OnParametersSet()
    {
        if (_cachedApiCollection == ApiCollection)
        {
            return;
        }
        _cachedApiCollection = ApiCollection;
        GroupApiClients(3);
    }

    private bool _shouldRender = true;
    protected override bool ShouldRender()
    {
        if (_shouldRender)
        {
            _shouldRender = false;
            return true;
        }
        return false;
    }

    private int _groups;
    private void GroupApiClients(int groups)
    {
        if(groups == _groups) return;
        _groups = groups;
        ApiClientGroups = GroupEqually(ApiCollection?.ApiClients ?? new(), _groups);
        _shouldRender = true;
        StateHasChanged();
    }

    private static List<List<T>> GroupEqually<T>(List<T> list, int numberOfGroups)
    {
        int itemsPerGroup = (int)Math.Ceiling((double)list.Count / numberOfGroups);
        List<List<T>> groupedLists = new List<List<T>>();

        for (int i = 0; i < list.Count; i += itemsPerGroup)
        {
            List<T> group = list.Skip(i).Take(itemsPerGroup).ToList();
            groupedLists.Add(group);
        }

        return groupedLists;
    }

}

